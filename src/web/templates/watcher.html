{% extends "base.html" %}

{% block title %}Watcher - KMGI Radio Automation{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Nurpe Download Watcher</h1>
    <p>Monitor and automatically process new music downloads</p>
</div>

<div class="card">
    <h3>Status</h3>
    <div class="status-indicator {% if status.watching %}status-active{% else %}status-inactive{% endif %}">
        {{ 'ACTIVE' if status.watching else 'STOPPED' }}
    </div>

    <table class="data-table">
        <tr>
            <td>Watch Path</td>
            <td><code>{{ status.watch_path }}</code></td>
        </tr>
        <tr>
            <td>Queue Size</td>
            <td>{{ status.queue_size }} files pending</td>
        </tr>
        <tr>
            <td>Watched Extensions</td>
            <td>{{ status.extensions|join(', ') }}</td>
        </tr>
        <tr>
            <td>Auto-Categorize</td>
            <td>{{ 'Yes' if status.auto_categorize else 'No' }}</td>
        </tr>
        <tr>
            <td>Move Files</td>
            <td>{{ 'Yes' if status.move_files else 'No' }}</td>
        </tr>
    </table>
</div>

<div class="card">
    <h3>Controls</h3>
    <div class="button-group">
        {% if status.watching %}
        <button class="btn btn-danger" onclick="stopWatcher()">Stop Watcher</button>
        {% else %}
        <button class="btn btn-success" onclick="startWatcher()">Start Watcher</button>
        {% endif %}
        <button class="btn btn-primary" onclick="scanFolder()">Scan Existing Files</button>
    </div>
</div>

<div class="card">
    <h3>Processing Log</h3>
    <div id="processingLog" class="log-container">
        <p class="text-muted">Processing events will appear here...</p>
    </div>
</div>

<div class="card">
    <h3>Manual Processing</h3>
    <p>Process a single file manually:</p>
    <form onsubmit="processFile(event)">
        <div class="form-group">
            <input type="text" id="filePath" placeholder="Enter file path..." class="form-control" style="width: 70%; display: inline-block;">
            <button type="submit" class="btn btn-primary">Process</button>
        </div>
    </form>
    <div id="processResult" style="display: none; margin-top: 20px;"></div>
</div>

<script>
function startWatcher() {
    fetch('/api/watcher/start', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            addLog('Watcher started');
            location.reload();
        });
}

function stopWatcher() {
    fetch('/api/watcher/stop', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            addLog('Watcher stopped');
            location.reload();
        });
}

function scanFolder() {
    addLog('Scanning folder for existing files...');
    fetch('/api/watcher/scan', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            addLog(`Scan complete: ${data.stats.processed} processed, ${data.stats.skipped} skipped, ${data.stats.errors} errors`);
        });
}

function processFile(e) {
    e.preventDefault();
    const filePath = document.getElementById('filePath').value;

    fetch('/api/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ file_path: filePath })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('processResult').style.display = 'block';

        if (data.error) {
            document.getElementById('processResult').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            let html = `<div class="alert alert-success">Status: ${data.status}</div>`;
            if (data.metadata) {
                html += `<p><strong>${data.metadata.artist} - ${data.metadata.title}</strong></p>`;
                html += `<p>Category: ${data.metadata.category || 'Not set'}</p>`;
                html += `<p>Genre: ${data.metadata.genre || 'Not set'}</p>`;
            }
            if (data.new_path) {
                html += `<p>New location: <code>${data.new_path}</code></p>`;
            }
            if (data.errors && data.errors.length > 0) {
                html += '<h5>Warnings:</h5><ul>';
                data.errors.forEach(err => html += `<li>${err}</li>`);
                html += '</ul>';
            }
            document.getElementById('processResult').innerHTML = html;
            addLog(`Processed: ${data.metadata?.title || filePath}`);
        }
    })
    .catch(err => {
        document.getElementById('processResult').innerHTML = `<div class="alert alert-danger">Error processing file</div>`;
    });
}

function addLog(message) {
    const log = document.getElementById('processingLog');
    const time = new Date().toLocaleTimeString();
    log.innerHTML = `<div class="log-entry">[${time}] ${message}</div>` + log.innerHTML;
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Audit - KMGI Radio Automation{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Rotation Audit</h1>
    <p>Monitor rotation patterns and generate reports</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ quick_stats.total_plays or 0 }}</div>
        <div class="stat-label">Plays (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ quick_stats.unique_songs or 0 }}</div>
        <div class="stat-label">Unique Songs (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ weekly_stats.total_plays or 0 }}</div>
        <div class="stat-label">Plays (7 days)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ weekly_stats.unique_songs or 0 }}</div>
        <div class="stat-label">Unique Songs (7 days)</div>
    </div>
</div>

<div class="card">
    <h3>Generate Report</h3>
    <p>Generate a comprehensive weekly rotation audit report.</p>
    <button class="btn btn-primary" onclick="generateReport()" id="generateBtn">Generate Weekly Report</button>
    <div id="reportResult" style="display: none; margin-top: 20px;">
        <h4>Report Generated</h4>
        <div id="reportSummary"></div>
        <div id="reportRecommendations"></div>
    </div>
</div>

<div class="card">
    <h3>Category Distribution (24 Hours)</h3>
    {% if quick_stats.categories %}
    <div class="category-bars">
        {% set total = quick_stats.total_plays or 1 %}
        {% for cat, count in quick_stats.categories.items() %}
        <div class="category-bar">
            <span class="bar-label">{{ cat }}</span>
            <div class="bar-container">
                <div class="bar-fill" style="width: {{ (count / total * 100)|round }}%"></div>
            </div>
            <span class="bar-value">{{ count }} ({{ ((count / total) * 100)|round(1) }}%)</span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No play data available</p>
    {% endif %}
</div>

<div class="card">
    <h3>Recent Reports</h3>
    {% if recent_reports %}
    <table class="data-table full-width">
        <thead>
            <tr>
                <th>Type</th>
                <th>Period</th>
                <th>Generated</th>
                <th>Total Plays</th>
                <th>Violations</th>
            </tr>
        </thead>
        <tbody>
            {% for report in recent_reports %}
            <tr>
                <td>{{ report.report_type }}</td>
                <td>{{ report.start_date.strftime('%Y-%m-%d') }} - {{ report.end_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ report.generated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>{{ report.summary.total_plays if report.summary else 'N/A' }}</td>
                <td>{{ report.violations|length if report.violations else 0 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No reports generated yet</p>
    {% endif %}
</div>

<script>
function generateReport() {
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    fetch('/api/audit/generate', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = 'Generate Weekly Report';

            if (data.success) {
                document.getElementById('reportResult').style.display = 'block';

                let summaryHtml = '<table class="data-table">';
                for (const [key, value] of Object.entries(data.summary)) {
                    summaryHtml += `<tr><td>${key.replace(/_/g, ' ')}</td><td><strong>${value}</strong></td></tr>`;
                }
                summaryHtml += '</table>';
                document.getElementById('reportSummary').innerHTML = summaryHtml;

                let recsHtml = '<h4>Recommendations</h4><ul>';
                data.recommendations.forEach(rec => {
                    recsHtml += `<li>${rec}</li>`;
                });
                recsHtml += '</ul>';
                document.getElementById('reportRecommendations').innerHTML = recsHtml;
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.textContent = 'Generate Weekly Report';
            alert('Error generating report');
        });
}
</script>
{% endblock %}
